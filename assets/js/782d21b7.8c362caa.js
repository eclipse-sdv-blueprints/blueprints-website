"use strict";(self.webpackChunkblueprints_website=self.webpackChunkblueprints_website||[]).push([[708],{5788:(e,n,t)=>{t.d(n,{Iu:()=>p,yg:()=>u});var a=t(1504);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var l=a.createContext({}),c=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(l.Provider,{value:n},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(t),h=o,u=d["".concat(l,".").concat(h)]||d[h]||m[h]||i;return t?a.createElement(u,r(r({ref:n},p),{},{components:t})):a.createElement(u,r({ref:n},p))}));function u(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=t.length,r=new Array(i);r[0]=h;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s[d]="string"==typeof e?e:o,r[1]=s;for(var c=2;c<i;c++)r[c]=t[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},5296:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>m,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var a=t(5072),o=(t(1504),t(5788));const i={},r="Deploy Application",s={unversionedId:"companion-application/deploy-seat-adjuster",id:"companion-application/deploy-seat-adjuster",title:"Deploy Application",description:"We now want to deploy the application to a target device.",source:"@site/docs/companion-application/deploy-seat-adjuster.md",sourceDirName:"companion-application",slug:"/companion-application/deploy-seat-adjuster",permalink:"/docs/companion-application/deploy-seat-adjuster",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"overallSidebar",previous:{title:"Develop Application",permalink:"/docs/companion-application/develop-seat-adjuster"},next:{title:"Interact with Seat Adjuster",permalink:"/docs/companion-application/interact-seat-adjuster"}},l={},c=[{value:"Disable other containers",id:"disable-other-containers",level:2},{value:"Starting of container",id:"starting-of-container",level:2},{value:"Use <code>kanto-cm</code>",id:"use-kanto-cm",level:3},{value:"Add manifest for seat adjuster",id:"add-manifest-for-seat-adjuster",level:3},{value:"Mock Service",id:"mock-service",level:2},{value:"seat-application.json",id:"seat-applicationjson",level:2},{value:"mock.py",id:"mockpy",level:2},{value:"mockservice.json",id:"mockservicejson",level:2}],p={toc:c},d="wrapper";function m(e){let{components:n,...t}=e;return(0,o.yg)(d,(0,a.c)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,o.yg)("h1",{id:"deploy-application"},"Deploy Application"),(0,o.yg)("p",null,"We now want to deploy the application to a target device.\nYou may follow the remainder of this guide on a separate device like a RaspberryPi, but you can emulate such a device on your development machine too.\nEither way, we use Eclipse Leda in version 0.1.0-M2 as the target system, which is a Linux-based distribution with pre-installed SDV components like the KUKSA Databroker\nand Eclipse Kanto for container management.\nFor more details on how to download and run Eclipse Leda, follow the respective guides:"),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("a",{parentName:"li",href:"https://eclipse-leda.github.io/leda/docs/general-usage/running-qemu/"},"QEMU")),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("a",{parentName:"li",href:"https://eclipse-leda.github.io/leda/docs/general-usage/docker-setup/"},"Docker")),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("a",{parentName:"li",href:"https://eclipse-leda.github.io/leda/docs/general-usage/raspberry-pi/"},"RaspberryPi")),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("a",{parentName:"li",href:"https://eclipse-leda.github.io/leda/docs/general-usage/linux-setup/"},"Linux"))),(0,o.yg)("p",null,"We recommend to get started with the QEMU setup.\nIn any case, you now need to configure Eclipse Kanto to execute the application.\nFor this, it helps to get an overview of which containers are currently running in Eclipse Kanto. You can get this through the command:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-bash"},"kantui\n")),(0,o.yg)("p",null,"or"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-bash"},"kanto-cm list\n")),(0,o.yg)("p",null,"From this list, ensure that at least the KUKSA Databroker runs, which should be the case since it is are pre-configured\nwith the Eclipse Leda release."),(0,o.yg)("p",null,"In Eclipse Kanto, you can manage a container with the command line application ",(0,o.yg)("inlineCode",{parentName:"p"},"kanto-cm")," or container manifest files describing a desired container execution.\nThe advantage of using the container manifests is that the configuration is persisted across a reboot of the system and is easier to use\nto describe a desired software state for the overall vehicle."),(0,o.yg)("p",null,"Eclipse Leda has the ",(0,o.yg)("inlineCode",{parentName:"p"},"kanto-auto-deployer")," systemd service, which applies any changes to the manifests in ",(0,o.yg)("inlineCode",{parentName:"p"},"/data/var/containers/manifests")," to Eclipse Kanto.\nThus, the typical way to add or adapt containers is to modify the corresponding container manifest."),(0,o.yg)("h2",{id:"disable-other-containers"},"Disable other containers"),(0,o.yg)("p",null,"The release 0.1.0-M2 of Eclipse Leda comes with a number of pre-configured and automatically executed containers.\nOne of these containers is the ",(0,o.yg)("inlineCode",{parentName:"p"},"feedercan")," that feeds changing values from a recording for signals such as ",(0,o.yg)("inlineCode",{parentName:"p"},"Vehicle.Speed")," to the KUKSA Databroker.\nThese values interfere with the seat adjuster application, which only moves the seat if the vehicle speed is zero.\nAnother interfering container is the ",(0,o.yg)("inlineCode",{parentName:"p"},"seatservice-example")," which reacts to changes in the signal ",(0,o.yg)("inlineCode",{parentName:"p"},"Vehicle.Cabin.Seat.Row1.Pos1.Position"),"\nand which we replace later with the ",(0,o.yg)("inlineCode",{parentName:"p"},"mock service"),"."),(0,o.yg)("p",null,"Therefore, we need to stop the ",(0,o.yg)("inlineCode",{parentName:"p"},"feedercan")," and the ",(0,o.yg)("inlineCode",{parentName:"p"},"seatservice-example")," container.\nThis is possible in ",(0,o.yg)("inlineCode",{parentName:"p"},"kantui")," by selecting the respective entry and pressing ",(0,o.yg)("inlineCode",{parentName:"p"},"r"),". The processing of this input may take a couple of seconds and the command is case-sensitive.\nIn addition, you need to remove the corresponding container manifests in ",(0,o.yg)("inlineCode",{parentName:"p"},"/data/var/containers/manifests")," to avoid that the Eclipse Kanto\nauto-deployer re-deploys these containers. Another approach is to change the ending of the not-needed manifests to something other than ",(0,o.yg)("inlineCode",{parentName:"p"},".json"),", like ",(0,o.yg)("inlineCode",{parentName:"p"},".disabled"),"."),(0,o.yg)("p",null,"If the ",(0,o.yg)("inlineCode",{parentName:"p"},"feedercan")," container still runs, the seat adjuster application app will later respond with the following error message:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-json"},'seatadjuster/setPosition/response\n {"requestId": "12345", "result": {"status": 1, "message": "Not allowed to move seat because vehicle speed is 9.0 and not 0"}}\n')),(0,o.yg)("p",null,"Since they consume resources and are not needed for the seat adjustment, you may remove the containers and manifests for ",(0,o.yg)("inlineCode",{parentName:"p"},"cloudconnector"),",\n",(0,o.yg)("inlineCode",{parentName:"p"},"hvacservice-example"),", ",(0,o.yg)("inlineCode",{parentName:"p"},"sua"),", or ",(0,o.yg)("inlineCode",{parentName:"p"},"vum")," as well."),(0,o.yg)("h2",{id:"starting-of-container"},"Starting of container"),(0,o.yg)("p",null,"The quickest way to start the container is to use the ",(0,o.yg)("inlineCode",{parentName:"p"},"kanto-cm create")," command from the terminal. However, this configuration does not persist across a reboot of your Eclipse Leda instance. We, therefore, recommend that you use the approach described below to add a container manifest. The container manifest is a bit like creating a Pod or Deployment description in Kubernetes."),(0,o.yg)("h3",{id:"use-kanto-cm"},"Use ",(0,o.yg)("inlineCode",{parentName:"h3"},"kanto-cm")),(0,o.yg)("p",null,"To start the container in Eclipse Kanto from the terminal, you can use the following command. Before pasting the command to the terminal, replace the placeholders in ",(0,o.yg)("inlineCode",{parentName:"p"},"<>")," with the URL of your seat application container image. One example is:"),(0,o.yg)("p",null,(0,o.yg)("inlineCode",{parentName:"p"},"ghcr.io/yourGitHubUser/seat-application/seatadjuster:0.0.5")),(0,o.yg)("p",null,"The full URL for your container is available on GitHub. Select the container under ",(0,o.yg)("inlineCode",{parentName:"p"},"Packages")," on the right side of the ",(0,o.yg)("inlineCode",{parentName:"p"},"Code")," tab view. You should then see the package overview and can check the URL in the installation example behind ",(0,o.yg)("inlineCode",{parentName:"p"},"docker pull"),"."),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-bash"},'kanto-cm create --name seatadjuster-app --e="SDV_SEATSERVICE_ADDRESS=grpc://seatservice-example:50051" --e="SDV_MQTT_ADDRESS=mqtt://mosquitto:1883" --e="SDV_VEHICLEDATABROKER_ADDRESS=grpc://databroker:55555" --e="SDV_MIDDLEWARE_TYPE=native" --hosts="databroker:container_databroker-host, mosquitto:host_ip, seatservice-example:container_seatservice-example-host" ghcr.io/<identifier-for-container>:<tag-for-container>\n\nkanto-cm start --name seatadjuster-app\nkanto-cm logs --name seatadjuster-app\n')),(0,o.yg)("h3",{id:"add-manifest-for-seat-adjuster"},"Add manifest for seat adjuster"),(0,o.yg)("p",null,"As an alternative to using ",(0,o.yg)("inlineCode",{parentName:"p"},"kanto-cm"),", you can add a container manifest to the directoy watched by the ",(0,o.yg)("inlineCode",{parentName:"p"},"kanto-auto-deployer")," (",(0,o.yg)("inlineCode",{parentName:"p"},"data/var/containers/manifests"),")."),(0,o.yg)("p",null,"To add the container manifest, create a new file inside this folder."),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-bash"},"touch seat-adjuster.json\nnano seat-adjuster.json\n")),(0,o.yg)("p",null,"and copy the ",(0,o.yg)("a",{parentName:"p",href:"#seat-applicationjson"},"manifest from below"),". You can save the file with ",(0,o.yg)("inlineCode",{parentName:"p"},"strg+s")," and close the window with ",(0,o.yg)("inlineCode",{parentName:"p"},"strg+q"),"."),(0,o.yg)("p",null,"Inside the manifest file, you need to adapt the reference to your seat application container image by modifying ",(0,o.yg)("inlineCode",{parentName:"p"},"image.name"),". For more details on the URL for the container image, see the paragraph on using ",(0,o.yg)("inlineCode",{parentName:"p"},"kanto-cm create")," above."),(0,o.yg)("p",null,"You can create the file on the development machine and copy it via scp too:"),(0,o.yg)("p",null,(0,o.yg)("inlineCode",{parentName:"p"},"scp -P 2222 myapp.json root@localhost:/data/var/containers/manifests/")),(0,o.yg)("p",null,"The example deployment descriptor below is available in\n",(0,o.yg)("a",{parentName:"p",href:"https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example/seatadjuster-app.json.disabled"},"meta-leda-components"),"\ntoo.\nAn interesting aspect of the snippet is the ",(0,o.yg)("inlineCode",{parentName:"p"},"config.env")," section at the bottom of the container manifest.\nThere, we define a number of environment variables for the container\nwhich configures the Eclipse Velocitas SDK to use the native middleware and where to find the MQTT-broker and the KUKSA Databroker to use.\nWe did the same in ",(0,o.yg)("inlineCode",{parentName:"p"},"kanto-cm")," call behind the parameter ",(0,o.yg)("inlineCode",{parentName:"p"},"--e="),"."),(0,o.yg)("p",null,"More details on the general deployment approach can be found in ",(0,o.yg)("a",{parentName:"p",href:"https://eclipse-leda.github.io/leda/docs/app-deployment/velocitas/"},"Leda Vehicle Applications")),(0,o.yg)("p",null,"For the deployment to work,  Eclipse Kanto needs access rights to download the referenced container image. If your application repository is ",(0,o.yg)("inlineCode",{parentName:"p"},"private"),", you have to configure Eclipse Kanto with an access token to get the required access rights. More details on how to create and set the token are available in:"),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},"the ",(0,o.yg)("a",{parentName:"li",href:"/docs/companion-application/troubleshooting#you-get-a-401-unauthorized-error-when-trying-to-download-the-container-image-of-your-application"},"troubleshooting page")," at the end of this guide"),(0,o.yg)("li",{parentName:"ul"},"the ",(0,o.yg)("a",{parentName:"li",href:"https://eclipse-leda.github.io/leda/docs/device-provisioning/container-management/container-registries/"},"Eclipse Leda documentation"),".")),(0,o.yg)("p",null,"To make sure that Eclipse Kanto detects the changes in the ",(0,o.yg)("inlineCode",{parentName:"p"},"manifests")," folder, you can restart the respective system services:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-bash"},"systemctl restart kanto-auto-deployer\n")),(0,o.yg)("h2",{id:"mock-service"},"Mock Service"),(0,o.yg)("p",null,"As explained in the description of the code, the seat adjuster application sets the target value for the seat positions in the KUSKSA Datbroker\nand waits for the current position to update."),(0,o.yg)("p",null,"For this to function, there needs to be a component that reacts to this change by moving the seat and updating the current value accordingly.\nBecause we cannot assume that you have an actual ECU availabe for running this guide, we mock the vehicle behavior\nwith the ",(0,o.yg)("a",{parentName:"p",href:"https://github.com/eclipse/kuksa.val.services/tree/main/mock_service"},"vehicle mock service")," from the Eclipse Kuksa project."),(0,o.yg)("p",null,"The mock service allows the definition of custom interaction sequences with the KUKSA Databroker. For instance, one can react to changes to specific signals\nor update signals with a time trigger. You can define the sequences in a Python file like the example ",(0,o.yg)("a",{parentName:"p",href:"#mockpy"},(0,o.yg)("inlineCode",{parentName:"a"},"mock.py"))," below.\nThe snippet shows how to use a change to the target value for the seat position signal as a trigger to update the current value to the target value step-wise\nover a duration of 10 seconds."),(0,o.yg)("p",null,"For the deployment, you create another container manifest in ",(0,o.yg)("inlineCode",{parentName:"p"},"/data/var/containers/manifest")," with the content from ",(0,o.yg)("a",{parentName:"p",href:"#mockservicejson"},"below"),".\nThe container manifest also mounts a custom ",(0,o.yg)("inlineCode",{parentName:"p"},"mock.py")," into the container to replace the configuration of the ",(0,o.yg)("a",{parentName:"p",href:"https://github.com/eclipse/kuksa.val.services/blob/main/mock_service/mock.py"},"default mock.py"),".\nWith the container manifest below, Eclipse Kanto instead mounts from ",(0,o.yg)("inlineCode",{parentName:"p"},"/data/var/mock/mock.py"),".\nTherefore, you need to create this directory and the file with the content from below."),(0,o.yg)("p",null,"You may now check with ",(0,o.yg)("inlineCode",{parentName:"p"},"kantui")," or ",(0,o.yg)("inlineCode",{parentName:"p"},"kanto-cm list")," whether all components (",(0,o.yg)("inlineCode",{parentName:"p"},"databroker"),", ",(0,o.yg)("inlineCode",{parentName:"p"},"seatadjuster-app"),", and ",(0,o.yg)("inlineCode",{parentName:"p"},"mock-service"),") are running well.\nThe next step is to ",(0,o.yg)("a",{parentName:"p",href:"/docs/companion-application/interact-seat-adjuster"},"interact with the seat adjuster"),"."),(0,o.yg)("h2",{id:"seat-applicationjson"},"seat-application.json"),(0,o.yg)("p",null,"This is the Eclipse Kanto container manifest for the seat adjuster application."),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-json"},'{\n    "container_id": "seatadjuster-app",\n    "container_name": "seatadjuster-app",\n    "image": {\n        "name": "ghcr.io/<identifier-for-container>:<tag-for-container>"\n    },\n    "host_config": {\n        "devices": [],\n        "network_mode": "bridge",\n        "privileged": false,\n        "restart_policy": {\n            "maximum_retry_count": 0,\n            "retry_timeout": 0,\n            "type": "unless-stopped"\n        },\n        "runtime": "io.containerd.runc.v2",\n        "extra_hosts": [        \n                "mosquitto:host_ip",\n                "databroker:container_databroker-host",\n                "seatservice-example:container_seatservice-example-host"\n        ],\n        "port_mappings": [\n            {\n              "protocol": "tcp",\n              "container_port": 30151,\n              "host_ip": "localhost",\n              "host_port": 50151,\n              "host_port_end": 50151\n            }\n        ],\n        "log_config": {\n            "driver_config": {\n                "type": "json-file",\n                "max_files": 2,\n                "max_size": "1M",\n                "root_dir": ""\n            },\n            "mode_config": {\n                "mode": "blocking",\n                "max_buffer_size": ""\n            }\n        },\n        "resources": null\n    },\n    "config": {\n        "env": [\n           "SDV_SEATSERVICE_ADDRESS=grpc://seatservice-example:50051",\n           "SDV_VEHICLEDATABROKER_ADDRESS=grpc://databroker:55555",\n           "SDV_MQTT_ADDRESS=mqtt://mosquitto:1883",\n           "SDV_MIDDLEWARE_TYPE=native",\n           "RUST_LOG=info",\n           "vehicle_data_broker=info"\n        ],\n        "cmd": []\n    }\n}\n')),(0,o.yg)("h2",{id:"mockpy"},"mock.py"),(0,o.yg)("p",null,"This is the example ",(0,o.yg)("inlineCode",{parentName:"p"},"mock.py")," for mocking a seat provider:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-python"},'from lib.animator import RepeatMode\nfrom lib.dsl import (\n    create_animation_action,\n    create_behavior,\n    create_event_trigger,\n    create_set_action,\n    get_datapoint_value,\n    mock_datapoint,\n)\n\nfrom lib.trigger import ClockTrigger, EventType\n\nmock_datapoint(\n    path="Vehicle.Cabin.Seat.Row1.Pos1.Position",\n    initial_value=0,\n    behaviors=[\n        create_behavior(\n            trigger=create_event_trigger(EventType.ACTUATOR_TARGET),\n            action=create_animation_action(\n                duration=10.0,\n                values=["$self", "$event.value"],\n            ),\n        )\n    ],\n)\n\n')),(0,o.yg)("h2",{id:"mockservicejson"},"mockservice.json"),(0,o.yg)("p",null,"The container manifest for the mockservice may look like the following snippet. Note, that the files referenced in the ",(0,o.yg)("inlineCode",{parentName:"p"},"source")," of the ",(0,o.yg)("inlineCode",{parentName:"p"},"mount_points"),"\nneeds to be present in the file system of your Eclipse Leda instance."),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-json"},'{\n    "container_id": "mockservice",\n    "container_name": "mockservice",\n    "image": {\n        "name": "ghcr.io/eclipse/kuksa.val.services/mock_service:latest"\n    },\n    "mount_points": [\n        {\n            "source": "/data/var/mock/mock.py",\n            "destination": "/mock.py",\n            "propagation_mode": "rprivate"\n        }\n    ],\n    "host_config": {\n        "network_mode": "bridge",\n        "privileged": false,\n        "restart_policy": {\n            "maximum_retry_count": 0,\n            "retry_timeout": 0,\n            "type": "unless-stopped"\n        },\n        "runtime": "io.containerd.runc.v2",\n        "extra_hosts": [\n            "databroker:container_databroker-host"\n        ],\n        "log_config": {\n            "driver_config": {\n                "type": "json-file",\n                "max_files": 2,\n                "max_size": "1M",\n                "root_dir": ""\n            },\n            "mode_config": {\n                "mode": "blocking",\n                "max_buffer_size": ""\n            }\n        }\n    },\n    "config": {\n        "env": [\n           "VDB_ADDRESS=databroker:55555"\n        ]\n    }\n}\n')))}m.isMDXComponent=!0}}]);